<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ å¯†è²¨å¹£è½‰æ›å™¨ï½œæ¸¬è©¦ç‰ˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #111;
            color: white;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1000px;
            margin: auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
        }

        /* å®‰å…¨è­¦å‘Š */
        .security-warning {
            background: linear-gradient(135deg, #ff6b6b, #c92a2a);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 5px solid #ffd700;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.9; }
            50% { opacity: 1; }
            100% { opacity: 0.9; }
        }

        .security-warning h3 {
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .warning-icon {
            font-size: 24px;
        }

        .api-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .status-testing {
            background: #f39c12;
            color: #000;
        }

        .status-working {
            background: #27ae60;
            color: white;
        }

        .status-error {
            background: #e74c3c;
            color: white;
        }

        /* å›ºå®šåƒ¹æ ¼é¡¯ç¤º */
        .price-banner {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }

        .price-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .price-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 480px) {
            .price-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .price-item {
            background: #222;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #0a84ff;
            transition: transform 0.2s;
        }

        .price-item:hover {
            transform: translateY(-2px);
            background: #2a2a2a;
        }

        .price-symbol {
            font-weight: bold;
            color: #0a84ff;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .price-name {
            font-size: 10px;
            color: #aaa;
            margin-bottom: 3px;
        }

        .price-value {
            font-size: 16px;
            font-weight: bold;
        }

        .card {
            background: #1b1b1b;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        select, input {
            padding: 10px;
            width: 100%;
            margin-top: 10px;
            background: #333;
            border: 1px solid #444;
            border-radius: 5px;
            color: white;
        }

        button {
            width: 100%;
            padding: 12px;
            background: #0a84ff;
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            font-size: 16px;
            margin-top: 10px;
            cursor: pointer;
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
        }

        #result {
            padding: 15px;
            margin-top: 10px;
            background: #222;
            border-radius: 8px;
            text-align: center;
            font-size: 20px;
        }

        .error {
            color: #ff6b6b;
        }

        .success {
            color: #4cd964;
        }

        .loading {
            color: #0a84ff;
        }

        /* è¨ˆç®—æ©Ÿæ¨£å¼ */
        .calculator {
            margin-top: 20px;
        }

        .calculator input {
            font-size: 24px;
            text-align: right;
        }

        .calc-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .calc-btn {
            padding: 18px;
            font-size: 18px;
            background: #333;
        }

        .last-updated {
            text-align: center;
            font-size: 12px;
            color: #888;
            margin-top: 10px;
        }
        
        .refresh-btn {
            background: #333;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            display: inline-block;
            margin-left: 10px;
            transition: background 0.2s;
        }
        
        .refresh-btn:hover {
            background: #444;
        }
        
        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .currency-count {
            font-size: 12px;
            color: #0a84ff;
            background: rgba(10, 132, 255, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .debug-info {
            background: #222;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            font-size: 11px;
            color: #aaa;
            border: 1px solid #333;
        }
        
        .debug-info pre {
            margin: 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>

<body>
<div class="container">
    <!-- å®‰å…¨è­¦å‘Š -->
    <div class="security-warning">
        <h3>
            <span class="warning-icon">âš ï¸</span>
            <span>æ¸¬è©¦æ¨¡å¼ - API Key å¯è¦–</span>
            <span id="apiStatus" class="api-status status-testing">æ¸¬è©¦ä¸­</span>
        </h3>
        <p>é€™æ˜¯æ¸¬è©¦ç‰ˆæœ¬ï¼ŒAPI Key åœ¨å‰ç«¯å¯è¦‹ã€‚æ­£å¼ç™¼å¸ƒå‰å¿…é ˆè¨­ç½®å¾Œç«¯ä¿è­·ã€‚</p>
        <p style="font-size: 12px; margin-top: 8px;">
            <strong>æ³¨æ„ï¼š</strong>æ­¤é é¢åƒ…ä¾›æ¸¬è©¦ï¼Œå®Œæˆæ¸¬è©¦å¾Œè«‹ç«‹å³ç§»é™¤ API Keyã€‚
        </p>
    </div>
    
    <h1>åŠ å¯†è²¨å¹£è½‰æ›å™¨</h1>
    
    <!-- å›ºå®šåƒ¹æ ¼é¡¯ç¤ºå€å¡Š -->
    <div class="price-banner">
        <div class="header-controls">
            <h3 style="margin: 0;">ğŸ“Š å³æ™‚åŠ å¯†è²¨å¹£åƒ¹æ ¼ (USD)</h3>
            <div style="display: flex; align-items: center; gap: 10px;">
                <div class="currency-count">10 ç¨®è²¨å¹£</div>
                <div class="refresh-btn" onclick="loadPrices()" title="æ‰‹å‹•æ›´æ–°">ğŸ”„ æ›´æ–°</div>
            </div>
        </div>
        
        <div id="priceContainer" class="price-grid">
            <!-- 10å€‹å¹£ç¨® -->
            <div class="price-item">
                <div class="price-symbol">BTC</div>
                <div class="price-name">Bitcoin</div>
                <div class="price-value" id="btc-price">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="price-item">
                <div class="price-symbol">ETH</div>
                <div class="price-name">Ethereum</div>
                <div class="price-value" id="eth-price">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="price-item">
                <div class="price-symbol">SOL</div>
                <div class="price-name">Solana</div>
                <div class="price-value" id="sol-price">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="price-item">
                <div class="price-symbol">BNB</div>
                <div class="price-name">Binance Coin</div>
                <div class="price-value" id="bnb-price">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="price-item">
                <div class="price-symbol">XRP</div>
                <div class="price-name">Ripple</div>
                <div class="price-value" id="xrp-price">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="price-item">
                <div class="price-symbol">DOGE</div>
                <div class="price-name">Dogecoin</div>
                <div class="price-value" id="doge-price">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="price-item">
                <div class="price-symbol">ADA</div>
                <div class="price-name">Cardano</div>
                <div class="price-value" id="ada-price">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="price-item">
                <div class="price-symbol">PEPE</div>
                <div class="price-name">Pepe</div>
                <div class="price-value" id="pepe-price">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="price-item">
                <div class="price-symbol">ZEC</div>
                <div class="price-name">Zcash</div>
                <div class="price-value" id="zec-price">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="price-item">
                <div class="price-symbol">SUI</div>
                <div class="price-name">Sui</div>
                <div class="price-value" id="sui-price">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
        
        <!-- èª¿è©¦ä¿¡æ¯ï¼ˆå¯å±•é–‹ï¼‰ -->
        <details style="margin-top: 15px;">
            <summary style="cursor: pointer; color: #aaa; font-size: 12px;">é¡¯ç¤ºèª¿è©¦ä¿¡æ¯</summary>
            <div class="debug-info">
                <div><strong>API ç‹€æ…‹:</strong> <span id="debugStatus">æº–å‚™ä¸­...</span></div>
                <div><strong>æœ€å¾Œè«‹æ±‚:</strong> <span id="lastRequest">--</span></div>
                <div><strong>è«‹æ±‚æ¬¡æ•¸:</strong> <span id="requestCount">0</span></div>
                <div><strong>API Key:</strong> <span id="keyPreview" style="font-family: monospace;">CG-uv86K...AUL8</span></div>
                <div style="margin-top: 5px;">
                    <button onclick="testAPIConnection()" style="width: auto; padding: 5px 10px; font-size: 12px;">æ¸¬è©¦ API é€£æ¥</button>
                    <button onclick="clearCache()" style="width: auto; padding: 5px 10px; font-size: 12px; background: #666;">æ¸…é™¤ç·©å­˜</button>
                </div>
            </div>
        </details>
        
        <div id="lastUpdated" class="last-updated">æœ€å¾Œæ›´æ–°æ™‚é–“: --</div>
    </div>
    
    <!-- è½‰æ›å™¨ -->
    <div class="card">
        <h2>å¹£å€¼è½‰æ›</h2>
        <label>é‡‘é¡</label>
        <input type="number" id="amount" value="1" step="any" min="0.00000001">
        
        <label>å¾</label>
        <select id="fromCurrency">
            <option value="BTC">BTC (Bitcoin)</option>
            <option value="ETH">ETH (Ethereum)</option>
            <option value="SOL">SOL (Solana)</option>
            <option value="BNB">BNB (Binance Coin)</option>
            <option value="ADA">ADA (Cardano)</option>
            <option value="XRP">XRP (Ripple)</option>
            <option value="DOGE">DOGE (Dogecoin)</option>
            <option value="PEPE">PEPE (Pepe)</option>
            <option value="ZEC">ZEC (Zcash)</option>
            <option value="SUI">SUI (Sui)</option>
            <option value="SHIB">SHIB (Shiba Inu)</option>
            <option value="USDT">USDT (Tether)</option>
        </select>
        
        <label>åˆ°</label>
        <select id="toCurrency">
            <option value="HKD">HKD (æ¸¯å…ƒ)</option>
            <option value="USD">USD (ç¾å…ƒ)</option>
            <option value="CNY">CNY (äººæ°‘å¹£)</option>
            <option value="TWD">TWD (æ–°å°å¹£)</option>
            <option value="JPY">JPY (æ—¥åœ“)</option>
            <option value="EUR">EUR (æ­å…ƒ)</option>
            <option value="BTC">BTC (Bitcoin)</option>
            <option value="ETH">ETH (Ethereum)</option>
            <option value="USDT">USDT (Tether)</option>
        </select>
        
        <button id="convertBtn" onclick="convert()">ç«‹å³è½‰æ›</button>
        <div id="result">è¼¸å…¥é‡‘é¡ä¸¦é¸æ“‡è²¨å¹£é€²è¡Œè½‰æ›</div>
    </div>
    
    <!-- è¨ˆç®—æ©Ÿ -->
    <div class="card calculator">
        <h2>è¨ˆç®—æ©Ÿ</h2>
        <input type="text" id="calcDisplay" value="0" readonly>
        <div class="calc-grid">
            <button class="calc-btn" onclick="calc('7')">7</button>
            <button class="calc-btn" onclick="calc('8')">8</button>
            <button class="calc-btn" onclick="calc('9')">9</button>
            <button class="calc-btn" onclick="calc('/')">Ã·</button>
            <button class="calc-btn" onclick="calc('4')">4</button>
            <button class="calc-btn" onclick="calc('5')">5</button>
            <button class="calc-btn" onclick="calc('6')">6</button>
            <button class="calc-btn" onclick="calc('*')">Ã—</button>
            <button class="calc-btn" onclick="calc('1')">1</button>
            <button class="calc-btn" onclick="calc('2')">2</button>
            <button class="calc-btn" onclick="calc('3')">3</button>
            <button class="calc-btn" onclick="calc('-')">âˆ’</button>
            <button class="calc-btn" onclick="calc('0')">0</button>
            <button class="calc-btn" onclick="calc('.')">.</button>
            <button class="calc-btn" onclick="equals()">=</button>
            <button class="calc-btn" onclick="calc('+')">+</button>
            <button class="calc-btn" onclick="clearCalc()" style="grid-column: span 4; background:#c62828;">æ¸…é™¤</button>
        </div>
    </div>
</div>

<script>
// =====================
// ğŸ”§ é…ç½® - æ¸¬è©¦ç”¨ï¼ˆå®Œæˆæ¸¬è©¦å¾Œç§»é™¤ï¼ï¼‰
// =====================
const API_KEY = "CG-uv86KDk1FuMqbYqFmxtuAUL8"; // âš ï¸ æ¸¬è©¦ç”¨ï¼Œå®Œæˆå¾Œç§»é™¤ï¼
const API_BASE = "https://api.coingecko.com/api/v3";

// åŠ å¯†è²¨å¹£å°æ‡‰è¡¨
const CRYPTO_IDS = {
    BTC: "bitcoin",
    ETH: "ethereum",
    SOL: "solana",
    BNB: "binancecoin",
    XRP: "ripple",
    DOGE: "dogecoin",
    ADA: "cardano",
    PEPE: "pepe",
    ZEC: "zcash",
    SUI: "sui",
    SHIB: "shiba-inu",
    USDT: "tether"
};

// 10å€‹ç†±é–€å¹£ç¨®
const HOT_CRYPTO = ["BTC", "ETH", "SOL", "BNB", "XRP", "DOGE", "ADA", "PEPE", "ZEC", "SUI"];

// ç‹€æ…‹è®Šé‡
let requestCount = 0;
let exchangeRates = {};

// =====================
// ğŸ“Š æ›´æ–°èª¿è©¦ä¿¡æ¯
// =====================
function updateDebugInfo(status) {
    document.getElementById('debugStatus').textContent = status;
    document.getElementById('requestCount').textContent = requestCount;
    document.getElementById('lastRequest').textContent = new Date().toLocaleTimeString();
}

// =====================
// ğŸ”§ æ¸¬è©¦ API é€£æ¥
// =====================
async function testAPIConnection() {
    updateDebugInfo("æ¸¬è©¦é€£æ¥ä¸­...");
    
    try {
        const testUrl = `${API_BASE}/ping`;
        const response = await fetch(testUrl);
        
        if (response.ok) {
            updateDebugInfo("API é€£æ¥æ­£å¸¸ âœ“");
            document.getElementById('apiStatus').className = "api-status status-working";
            document.getElementById('apiStatus').textContent = "API æ­£å¸¸";
            return true;
        } else {
            updateDebugInfo(`é€£æ¥å¤±æ•—: ${response.status}`);
            return false;
        }
    } catch (error) {
        updateDebugInfo(`éŒ¯èª¤: ${error.message}`);
        document.getElementById('apiStatus').className = "api-status status-error";
        document.getElementById('apiStatus').textContent = "API éŒ¯èª¤";
        return false;
    }
}

// =====================
// ğŸ”¥ è¼‰å…¥å³æ™‚åƒ¹æ ¼
// =====================
async function loadPrices() {
    try {
        updateDebugInfo("è«‹æ±‚åƒ¹æ ¼æ•¸æ“š...");
        requestCount++;
        
        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        HOT_CRYPTO.forEach(symbol => {
            const element = document.getElementById(`${symbol.toLowerCase()}-price`);
            if (element) {
                element.textContent = "è¼‰å…¥ä¸­...";
                element.className = "price-value loading";
            }
        });
        
        // ç²å–å¹£ç¨® ID
        const coinIds = HOT_CRYPTO.map(symbol => CRYPTO_IDS[symbol]).filter(Boolean);
        
        // æ§‹å»º API URL
        const url = `${API_BASE}/simple/price?ids=${coinIds.join(",")}&vs_currencies=usd`;
        
        // ä½¿ç”¨ API Key
        const options = {
            headers: {
                "x-cg-demo-api-key": API_KEY
            }
        };
        
        console.log("ğŸ“¡ ç™¼é€è«‹æ±‚åˆ°:", url);
        
        const res = await fetch(url, options);
        
        if (!res.ok) {
            throw new Error(`API éŒ¯èª¤: ${res.status} ${res.statusText}`);
        }
        
        const data = await res.json();
        console.log("âœ… API å›æ‡‰:", data);
        
        // æ›´æ–°æ¯å€‹å¹£ç¨®çš„åƒ¹æ ¼é¡¯ç¤º
        HOT_CRYPTO.forEach(symbol => {
            const coinId = CRYPTO_IDS[symbol];
            const elementId = `${symbol.toLowerCase()}-price`;
            const element = document.getElementById(elementId);
            
            if (element && data[coinId] && data[coinId].usd !== undefined) {
                const price = data[coinId].usd;
                const formattedPrice = formatPrice(price);
                element.textContent = formattedPrice;
                element.className = "price-value success";
                
                // ç·©å­˜åŒ¯ç‡
                exchangeRates[`${symbol}_USD`] = price;
            } else {
                element.textContent = "ç„¡æ•¸æ“š";
                element.className = "price-value error";
            }
        });
        
        // æ›´æ–°æœ€å¾Œæ›´æ–°æ™‚é–“
        const now = new Date();
        const timeString = now.toLocaleTimeString('zh-HK', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        document.getElementById('lastUpdated').textContent = `æœ€å¾Œæ›´æ–°æ™‚é–“: ${timeString}`;
        
        updateDebugInfo("æ•¸æ“šè¼‰å…¥æˆåŠŸ âœ“");
        return true;
        
    } catch (error) {
        console.error("âŒ è¼‰å…¥åƒ¹æ ¼å¤±æ•—:", error);
        updateDebugInfo(`éŒ¯èª¤: ${error.message}`);
        
        HOT_CRYPTO.forEach(symbol => {
            const elementId = `${symbol.toLowerCase()}-price`;
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = "è¼‰å…¥å¤±æ•—";
                element.className = "price-value error";
            }
        });
        
        document.getElementById('lastUpdated').textContent = `æ›´æ–°å¤±æ•—: ${error.message}`;
        return false;
    }
}

// =====================
// ğŸ”„ å¹£å€¼è½‰æ›
// =====================
async function convert() {
    const amount = parseFloat(document.getElementById("amount").value);
    const from = document.getElementById("fromCurrency").value;
    const to = document.getElementById("toCurrency").value;
    const resultDiv = document.getElementById("result");
    const convertBtn = document.getElementById("convertBtn");
    
    if (isNaN(amount) || amount <= 0) {
        resultDiv.innerHTML = '<span class="error">è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡</span>';
        return;
    }
    
    try {
        convertBtn.disabled = true;
        convertBtn.textContent = "è½‰æ›ä¸­...";
        resultDiv.innerHTML = '<span class="loading">å–å¾—åŒ¯ç‡ä¸­...</span>';
        
        updateDebugInfo(`è½‰æ›: ${from} â†’ ${to}`);
        
        let result, rate;
        
        // æƒ…æ³1: åŠ å¯†è²¨å¹£ â†’ æ³•å¹£
        if (isCrypto(from) && !isCrypto(to)) {
            rate = await getCryptoToFiatRate(from, to);
            result = amount * rate;
        }
        // æƒ…æ³2: æ³•å¹£ â†’ åŠ å¯†è²¨å¹£
        else if (!isCrypto(from) && isCrypto(to)) {
            rate = await getCryptoToFiatRate(to, from);
            result = amount / rate;
        }
        // æƒ…æ³3: åŠ å¯†è²¨å¹£ â†’ åŠ å¯†è²¨å¹£
        else if (isCrypto(from) && isCrypto(to)) {
            const fromRate = await getCryptoToFiatRate(from, "USD");
            const toRate = await getCryptoToFiatRate(to, "USD");
            rate = fromRate / toRate;
            result = amount * rate;
        }
        // æƒ…æ³4: æ³•å¹£ â†’ æ³•å¹£
        else {
            const usdToFrom = await getFiatRate("USD", from);
            const usdToTo = await getFiatRate("USD", to);
            rate = usdToTo / usdToFrom;
            result = amount * rate;
        }
        
        // æ ¼å¼åŒ–é¡¯ç¤º
        const formattedAmount = formatNumber(amount, from);
        const formattedResult = formatNumber(result, to);
        const formattedRate = formatNumber(rate, "rate");
        
        resultDiv.innerHTML = `
            <div class="success">
                <div style="font-size: 24px; margin-bottom: 10px;">
                    ${formattedAmount} ${from} = ${formattedResult} ${to}
                </div>
                <div style="font-size: 14px; color: #aaa;">
                    åŒ¯ç‡: 1 ${from} = ${formattedRate} ${to}
                </div>
            </div>
        `;
        
        updateDebugInfo("è½‰æ›æˆåŠŸ âœ“");
        
    } catch (error) {
        console.error("è½‰æ›å¤±æ•—:", error);
        resultDiv.innerHTML = `<span class="error">è½‰æ›å¤±æ•—: ${error.message}</span>`;
        updateDebugInfo(`è½‰æ›éŒ¯èª¤: ${error.message}`);
    } finally {
        convertBtn.disabled = false;
        convertBtn.textContent = "ç«‹å³è½‰æ›";
    }
}

// =====================
// ğŸ”§ è¼”åŠ©å‡½æ•¸
// =====================
async function getCryptoToFiatRate(crypto, fiat) {
    const cacheKey = `${crypto}_${fiat}`;
    
    if (exchangeRates[cacheKey]) {
        return exchangeRates[cacheKey];
    }
    
    const coinId = CRYPTO_IDS[crypto];
    if (!coinId) {
        throw new Error(`ä¸æ”¯æ´çš„åŠ å¯†è²¨å¹£: ${crypto}`);
    }
    
    const url = `${API_BASE}/simple/price?ids=${coinId}&vs_currencies=${fiat.toLowerCase()}`;
    
    const options = {
        headers: {
            "x-cg-demo-api-key": API_KEY
        }
    };
    
    const res = await fetch(url, options);
    
    if (!res.ok) {
        throw new Error(`API éŒ¯èª¤: ${res.status}`);
    }
    
    const data = await res.json();
    
    if (!data[coinId] || data[coinId][fiat.toLowerCase()] === undefined) {
        throw new Error(`ç„¡æ³•å–å¾— ${crypto} åˆ° ${fiat} çš„åŒ¯ç‡`);
    }
    
    const rate = data[coinId][fiat.toLowerCase()];
    exchangeRates[cacheKey] = rate;
    
    return rate;
}

async function getFiatRate(from, to) {
    // ç°¡åŒ–çš„å›ºå®šåŒ¯ç‡
    const rates = {
        "USD_HKD": 7.8,
        "USD_CNY": 7.2,
        "USD_TWD": 31.5,
        "USD_JPY": 145.0,
        "USD_EUR": 0.92,
        "HKD_USD": 0.128,
        "CNY_USD": 0.139,
        "TWD_USD": 0.032,
        "JPY_USD": 0.0069,
        "EUR_USD": 1.09
    };
    
    const key = `${from}_${to}`;
    if (rates[key]) return rates[key];
    
    const reverseKey = `${to}_${from}`;
    if (rates[reverseKey]) return 1 / rates[reverseKey];
    
    throw new Error(`ä¸æ”¯æ´çš„åŒ¯ç‡å°: ${from} to ${to}`);
}

function isCrypto(currency) {
    return CRYPTO_IDS.hasOwnProperty(currency);
}

function formatPrice(price) {
    if (price === undefined || price === null) return "N/A";
    
    if (price < 0.0001) {
        return `$${price.toFixed(8)}`;
    } else if (price < 0.01) {
        return `$${price.toFixed(6)}`;
    } else if (price < 1) {
        return `$${price.toFixed(4)}`;
    } else if (price < 1000) {
        return `$${price.toFixed(2)}`;
    } else if (price < 1000000) {
        return `$${price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    } else {
        return `$${(price/1000).toFixed(1)}K`;
    }
}

function formatNumber(value, currency) {
    if (isNaN(value) || !isFinite(value)) return "NaN";
    if (value === 0) return "0";
    
    if (Math.abs(value) < 0.000001) {
        return value.toExponential(4);
    } else if (Math.abs(value) < 0.01) {
        return value.toFixed(8);
    } else if (Math.abs(value) < 1) {
        return value.toFixed(6);
    } else if (Math.abs(value) < 10000) {
        return value.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 4
        });
    } else {
        return value.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
}

function clearCache() {
    exchangeRates = {};
    updateDebugInfo("ç·©å­˜å·²æ¸…é™¤");
    alert("ç·©å­˜å·²æ¸…é™¤ï¼Œä¸‹æ¬¡è«‹æ±‚å°‡é‡æ–°ç²å–æ•¸æ“šã€‚");
}

// =====================
// ğŸ”¢ è¨ˆç®—æ©Ÿ
// =====================
let calcVal = "0";

function calc(v) {
    if (calcVal === "0" && v !== '.') {
        calcVal = "";
    }
    
    if (v === '.' && calcVal.includes('.')) {
        const lastOperator = Math.max(
            calcVal.lastIndexOf('+'),
            calcVal.lastIndexOf('-'),
            calcVal.lastIndexOf('*'),
            calcVal.lastIndexOf('/')
        );
        
        const lastNumber = calcVal.substring(lastOperator + 1);
        if (lastNumber.includes('.')) {
            return;
        }
    }
    
    calcVal += v;
    updateCalc();
}

function equals() {
    try {
        let expression = calcVal
            .replace(/Ã—/g, '*')
            .replace(/Ã·/g, '/')
            .replace(/âˆ’/g, '-');
        
        const result = eval(expression);
        
        if (isNaN(result) || !isFinite(result)) {
            throw new Error("ç„¡æ•ˆè¨ˆç®—");
        }
        
        calcVal = String(result);
    } catch {
        calcVal = "éŒ¯èª¤";
    }
    updateCalc();
}

function clearCalc() {
    calcVal = "0";
    updateCalc();
}

function updateCalc() {
    document.getElementById("calcDisplay").value = calcVal;
}

// =====================
// ğŸš€ åˆå§‹åŒ–
// =====================
document.addEventListener('DOMContentLoaded', function() {
    console.log("ğŸ”‘ ä½¿ç”¨ API Key:", API_KEY.substring(0, 10) + "...");
    console.log("ğŸš€ åŠ å¯†è²¨å¹£è½‰æ›å™¨æ¸¬è©¦ç‰ˆå·²å•Ÿå‹•");
    
    // åˆå§‹æ¸¬è©¦é€£æ¥
    testAPIConnection();
    
    // è¼‰å…¥åƒ¹æ ¼
    loadPrices();
    
    // æ¯60ç§’æ›´æ–°
    setInterval(loadPrices, 60000);
    
    // äº‹ä»¶ç›£è½
    document.getElementById('amount').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') convert();
    });
    
    document.getElementById('fromCurrency').addEventListener('change', convert);
    document.getElementById('toCurrency').addEventListener('change', convert);
});
</script>
</body>
</html>
