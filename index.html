<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ å¯†è²¨å¹£è½‰æ›å™¨ï½œå³æ™‚åƒ¹æ ¼</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #111;
            color: white;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 900px;
            margin: auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
        }

        /* å›ºå®šåƒ¹æ ¼é¡¯ç¤º */
        .price-banner {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }

        .price-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            text-align: center;
        }

        .price-item {
            background: #222;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #0a84ff;
        }

        .price-symbol {
            font-weight: bold;
            color: #0a84ff;
            font-size: 14px;
        }

        .price-value {
            font-size: 16px;
            margin-top: 5px;
        }

        .card {
            background: #1b1b1b;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        select, input {
            padding: 10px;
            width: 100%;
            margin-top: 10px;
            background: #333;
            border: 1px solid #444;
            border-radius: 5px;
            color: white;
        }

        button {
            width: 100%;
            padding: 12px;
            background: #0a84ff;
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            font-size: 16px;
            margin-top: 10px;
            cursor: pointer;
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
        }

        #result {
            padding: 15px;
            margin-top: 10px;
            background: #222;
            border-radius: 8px;
            text-align: center;
            font-size: 20px;
        }

        .error {
            color: #ff6b6b;
        }

        .success {
            color: #4cd964;
        }

        .loading {
            color: #0a84ff;
        }

        /* è¨ˆç®—æ©Ÿæ¨£å¼ */
        .calculator {
            margin-top: 20px;
        }

        .calculator input {
            font-size: 24px;
            text-align: right;
        }

        .calc-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .calc-btn {
            padding: 18px;
            font-size: 18px;
            background: #333;
        }

        .last-updated {
            text-align: center;
            font-size: 12px;
            color: #888;
            margin-top: 10px;
        }
        
        .refresh-btn {
            background: #333;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            display: inline-block;
            margin-left: 10px;
        }
    </style>
</head>

<body>
<div class="container">
    <h1>åŠ å¯†è²¨å¹£è½‰æ›å™¨</h1>
    
    <!-- å›ºå®šåƒ¹æ ¼é¡¯ç¤ºå€å¡Š -->
    <div class="price-banner">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0;">ğŸ“Š å³æ™‚åŠ å¯†è²¨å¹£åƒ¹æ ¼ (USD)</h3>
            <div class="refresh-btn" onclick="loadPrices()" title="æ‰‹å‹•æ›´æ–°">ğŸ”„ æ›´æ–°</div>
        </div>
        <div id="priceContainer" class="price-grid">
            <!-- åƒ¹æ ¼å°‡å‹•æ…‹è¼‰å…¥ -->
            <div class="price-item">
                <div class="price-symbol">BTC</div>
                <div class="price-value" id="btc-price">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="price-item">
                <div class="price-symbol">ETH</div>
                <div class="price-value" id="eth-price">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="price-item">
                <div class="price-symbol">SOL</div>
                <div class="price-value" id="sol-price">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="price-item">
                <div class="price-symbol">BNB</div>
                <div class="price-value" id="bnb-price">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="price-item">
                <div class="price-symbol">XRP</div>
                <div class="price-value" id="xrp-price">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="price-item">
                <div class="price-symbol">DOGE</div>
                <div class="price-value" id="doge-price">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
        <div id="lastUpdated" class="last-updated">æœ€å¾Œæ›´æ–°æ™‚é–“: --</div>
    </div>
    
    <!-- è½‰æ›å™¨ -->
    <div class="card">
        <h2>å¹£å€¼è½‰æ›</h2>
        <label>é‡‘é¡</label>
        <input type="number" id="amount" value="1" step="any" min="0.00000001">
        
        <label>å¾</label>
        <select id="fromCurrency">
            <!-- ä¸»è¦åŠ å¯†è²¨å¹£ -->
            <option value="BTC">BTC (Bitcoin)</option>
            <option value="ETH">ETH (Ethereum)</option>
            <option value="SOL">SOL (Solana)</option>
            <option value="BNB">BNB (Binance Coin)</option>
            <option value="ADA">ADA (Cardano)</option>
            <option value="XRP">XRP (Ripple)</option>
            <option value="DOGE">DOGE (Dogecoin)</option>
            <option value="SHIB">SHIB (Shiba Inu)</option>
            <option value="USDT">USDT (Tether)</option>
            <option value="USDC">USDC (USD Coin)</option>
        </select>
        
        <label>åˆ°</label>
        <select id="toCurrency">
            <!-- æ³•å¹£ -->
            <option value="HKD">HKD (æ¸¯å…ƒ)</option>
            <option value="USD">USD (ç¾å…ƒ)</option>
            <option value="CNY">CNY (äººæ°‘å¹£)</option>
            <option value="TWD">TWD (æ–°å°å¹£)</option>
            <option value="JPY">JPY (æ—¥åœ“)</option>
            <option value="EUR">EUR (æ­å…ƒ)</option>
            
            <!-- åŠ å¯†è²¨å¹£ -->
            <option value="BTC">BTC (Bitcoin)</option>
            <option value="ETH">ETH (Ethereum)</option>
            <option value="USDT">USDT (Tether)</option>
        </select>
        
        <button id="convertBtn" onclick="convert()">ç«‹å³è½‰æ›</button>
        <div id="result">è¼¸å…¥é‡‘é¡ä¸¦é¸æ“‡è²¨å¹£é€²è¡Œè½‰æ›</div>
    </div>
    
    <!-- è¨ˆç®—æ©Ÿ -->
    <div class="card calculator">
        <h2>è¨ˆç®—æ©Ÿ</h2>
        <input type="text" id="calcDisplay" value="0" readonly>
        <div class="calc-grid">
            <button class="calc-btn" onclick="calc('7')">7</button>
            <button class="calc-btn" onclick="calc('8')">8</button>
            <button class="calc-btn" onclick="calc('9')">9</button>
            <button class="calc-btn" onclick="calc('/')">Ã·</button>
            <button class="calc-btn" onclick="calc('4')">4</button>
            <button class="calc-btn" onclick="calc('5')">5</button>
            <button class="calc-btn" onclick="calc('6')">6</button>
            <button class="calc-btn" onclick="calc('*')">Ã—</button>
            <button class="calc-btn" onclick="calc('1')">1</button>
            <button class="calc-btn" onclick="calc('2')">2</button>
            <button class="calc-btn" onclick="calc('3')">3</button>
            <button class="calc-btn" onclick="calc('-')">âˆ’</button>
            <button class="calc-btn" onclick="calc('0')">0</button>
            <button class="calc-btn" onclick="calc('.')">.</button>
            <button class="calc-btn" onclick="equals()">=</button>
            <button class="calc-btn" onclick="calc('+')">+</button>
            <button class="calc-btn" onclick="clearCalc()" style="grid-column: span 4; background:#c62828;">æ¸…é™¤</button>
        </div>
    </div>
</div>

<script>
// =====================
// ğŸ”§ é…ç½® - ä½¿ç”¨å…è²»å…¬å…± API
// =====================
const API_BASE = "https://api.coingecko.com/api/v3";

// ç°¡åŒ–çš„åŠ å¯†è²¨å¹£å°æ‡‰è¡¨
const CRYPTO_IDS = {
    BTC: "bitcoin",
    ETH: "ethereum",
    SOL: "solana",
    BNB: "binancecoin",
    ADA: "cardano",
    XRP: "ripple",
    DOGE: "dogecoin",
    SHIB: "shiba-inu",
    USDT: "tether",
    USDC: "usd-coin"
};

// è¦é¡¯ç¤ºçš„ç†±é–€å¹£ç¨®
const HOT_CRYPTO = ["BTC", "ETH", "SOL", "BNB", "XRP", "DOGE"];

// ç·©å­˜åŒ¯ç‡æ•¸æ“š
let exchangeRates = {};

// =====================
// ğŸ”¥ å³æ™‚åƒ¹æ ¼é¡¯ç¤º
// =====================
async function loadPrices() {
    try {
        // é¡¯ç¤ºè¼‰ä¸­ç‹€æ…‹
        HOT_CRYPTO.forEach(symbol => {
            const element = document.getElementById(`${symbol.toLowerCase()}-price`);
            if (element) {
                element.textContent = "è¼‰å…¥ä¸­...";
                element.className = "price-value loading";
            }
        });
        
        // ç²å–ç†±é–€å¹£ç¨®çš„ ID
        const coinIds = HOT_CRYPTO.map(symbol => CRYPTO_IDS[symbol]).filter(Boolean);
        
        if (coinIds.length === 0) {
            throw new Error("ç„¡æœ‰æ•ˆçš„å¹£ç¨®");
        }
        
        // æ§‹å»º API URL - å…è²» API
        const url = `${API_BASE}/simple/price?ids=${coinIds.join(",")}&vs_currencies=usd`;
        
        console.log("è«‹æ±‚åƒ¹æ ¼ URL:", url);
        
        const res = await fetch(url);
        
        if (!res.ok) {
            throw new Error(`API éŒ¯èª¤: ${res.status} ${res.statusText}`);
        }
        
        const data = await res.json();
        console.log("åƒ¹æ ¼ API å›æ‡‰:", data);
        
        // æ›´æ–°æ¯å€‹å¹£ç¨®çš„åƒ¹æ ¼é¡¯ç¤º
        HOT_CRYPTO.forEach(symbol => {
            const coinId = CRYPTO_IDS[symbol];
            const elementId = `${symbol.toLowerCase()}-price`;
            const element = document.getElementById(elementId);
            
            if (element && data[coinId] && data[coinId].usd !== undefined) {
                const price = data[coinId].usd;
                const formattedPrice = formatPrice(price);
                element.textContent = formattedPrice;
                element.className = "price-value success";
                
                // ç·©å­˜åŒ¯ç‡
                exchangeRates[`${symbol}_USD`] = price;
            } else {
                element.textContent = "ç„¡æ•¸æ“š";
                element.className = "price-value error";
            }
        });
        
        // æ›´æ–°æœ€å¾Œæ›´æ–°æ™‚é–“
        const now = new Date();
        const timeString = now.toLocaleTimeString('zh-HK', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        document.getElementById('lastUpdated').textContent = `æœ€å¾Œæ›´æ–°æ™‚é–“: ${timeString}`;
        
        return true;
        
    } catch (error) {
        console.error("è¼‰å…¥åƒ¹æ ¼å¤±æ•—:", error);
        HOT_CRYPTO.forEach(symbol => {
            const elementId = `${symbol.toLowerCase()}-price`;
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = "è¼‰å…¥å¤±æ•—";
                element.className = "price-value error";
            }
        });
        document.getElementById('lastUpdated').textContent = `æ›´æ–°å¤±æ•—: ${error.message}`;
        return false;
    }
}

// =====================
// ğŸ”„ å¹£å€¼è½‰æ›
// =====================
async function convert() {
    const amount = parseFloat(document.getElementById("amount").value);
    const from = document.getElementById("fromCurrency").value;
    const to = document.getElementById("toCurrency").value;
    const resultDiv = document.getElementById("result");
    const convertBtn = document.getElementById("convertBtn");
    
    if (isNaN(amount) || amount <= 0) {
        resultDiv.innerHTML = '<span class="error">è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡</span>';
        return;
    }
    
    try {
        convertBtn.disabled = true;
        convertBtn.textContent = "è½‰æ›ä¸­...";
        resultDiv.innerHTML = '<span class="loading">å–å¾—åŒ¯ç‡ä¸­...</span>';
        
        let result, rate;
        
        // æƒ…æ³1: åŠ å¯†è²¨å¹£ â†’ æ³•å¹£
        if (isCrypto(from) && !isCrypto(to)) {
            rate = await getCryptoToFiatRate(from, to);
            result = amount * rate;
        }
        // æƒ…æ³2: æ³•å¹£ â†’ åŠ å¯†è²¨å¹£
        else if (!isCrypto(from) && isCrypto(to)) {
            rate = await getCryptoToFiatRate(to, from); // åéä¾†ç²å–åŒ¯ç‡
            result = amount / rate;
        }
        // æƒ…æ³3: åŠ å¯†è²¨å¹£ â†’ åŠ å¯†è²¨å¹£
        else if (isCrypto(from) && isCrypto(to)) {
            const fromRate = await getCryptoToFiatRate(from, "USD");
            const toRate = await getCryptoToFiatRate(to, "USD");
            rate = fromRate / toRate;
            result = amount * rate;
        }
        // æƒ…æ³4: æ³•å¹£ â†’ æ³•å¹£ï¼ˆç°¡åŒ–è™•ç†ï¼‰
        else {
            // ç°¡å–®çš„å›ºå®šåŒ¯ç‡ï¼ˆåƒ…ä¾›æ¼”ç¤ºï¼‰
            const simpleRates = {
                "HKD_USD": 0.128,
                "USD_HKD": 7.8,
                "HKD_CNY": 0.92,
                "CNY_HKD": 1.09,
                "HKD_TWD": 4.0,
                "TWD_HKD": 0.25,
                "HKD_JPY": 18.5,
                "JPY_HKD": 0.054,
                "HKD_EUR": 0.118,
                "EUR_HKD": 8.5
            };
            
            const key = `${from}_${to}`;
            if (simpleRates[key]) {
                rate = simpleRates[key];
                result = amount * rate;
            } else {
                // é€šé USD ä¸­è½‰
                const toUSD = simpleRates[`${from}_USD`] || (1 / (simpleRates[`USD_${from}`] || 1));
                const fromUSD = simpleRates[`USD_${to}`] || (1 / (simpleRates[`${to}_USD`] || 1));
                
                if (toUSD && fromUSD) {
                    rate = toUSD * fromUSD;
                    result = amount * rate;
                } else {
                    throw new Error("ä¸æ”¯æ´æ­¤è²¨å¹£å°è½‰æ›");
                }
            }
        }
        
        // æ ¼å¼åŒ–é¡¯ç¤º
        const formattedAmount = formatNumber(amount, from);
        const formattedResult = formatNumber(result, to);
        const formattedRate = formatNumber(rate, "rate");
        
        resultDiv.innerHTML = `
            <div class="success">
                <div style="font-size: 24px; margin-bottom: 10px;">
                    ${formattedAmount} ${from} = ${formattedResult} ${to}
                </div>
                <div style="font-size: 14px; color: #aaa;">
                    åŒ¯ç‡: 1 ${from} = ${formattedRate} ${to}
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error("è½‰æ›å¤±æ•—:", error);
        resultDiv.innerHTML = `<span class="error">è½‰æ›å¤±æ•—: ${error.message}</span>`;
    } finally {
        convertBtn.disabled = false;
        convertBtn.textContent = "ç«‹å³è½‰æ›";
    }
}

// ç²å–åŠ å¯†è²¨å¹£åˆ°æ³•å¹£çš„åŒ¯ç‡
async function getCryptoToFiatRate(crypto, fiat) {
    const cacheKey = `${crypto}_${fiat}`;
    
    // æª¢æŸ¥ç·©å­˜
    if (exchangeRates[cacheKey]) {
        return exchangeRates[cacheKey];
    }
    
    const coinId = CRYPTO_IDS[crypto];
    if (!coinId) {
        throw new Error(`ä¸æ”¯æ´çš„åŠ å¯†è²¨å¹£: ${crypto}`);
    }
    
    // æ§‹å»º API URL
    const url = `${API_BASE}/simple/price?ids=${coinId}&vs_currencies=${fiat.toLowerCase()}`;
    
    console.log("è«‹æ±‚åŒ¯ç‡ URL:", url);
    
    const res = await fetch(url);
    
    if (!res.ok) {
        throw new Error(`API éŒ¯èª¤: ${res.status}`);
    }
    
    const data = await res.json();
    
    if (!data[coinId] || data[coinId][fiat.toLowerCase()] === undefined) {
        throw new Error(`ç„¡æ³•å–å¾— ${crypto} åˆ° ${fiat} çš„åŒ¯ç‡`);
    }
    
    const rate = data[coinId][fiat.toLowerCase()];
    
    // ç·©å­˜çµæœ
    exchangeRates[cacheKey] = rate;
    
    return rate;
}

// æª¢æŸ¥æ˜¯å¦ç‚ºåŠ å¯†è²¨å¹£
function isCrypto(currency) {
    return CRYPTO_IDS.hasOwnProperty(currency);
}

// æ ¼å¼åŒ–åƒ¹æ ¼é¡¯ç¤º
function formatPrice(price) {
    if (price === undefined || price === null) return "N/A";
    
    if (price < 0.01) {
        return `$${price.toFixed(6)}`;
    } else if (price < 1) {
        return `$${price.toFixed(4)}`;
    } else if (price < 1000) {
        return `$${price.toFixed(2)}`;
    } else {
        return `$${price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    }
}

// æ ¼å¼åŒ–æ•¸å­—é¡¯ç¤º
function formatNumber(value, currency) {
    if (isNaN(value) || !isFinite(value)) {
        return "NaN";
    }
    
    // æ ¹æ“šæ•¸å€¼å¤§å°æ±ºå®šæ ¼å¼
    if (value === 0) return "0";
    
    if (value < 0.000001) {
        return value.toExponential(4);
    } else if (value < 0.01) {
        return value.toFixed(8);
    } else if (value < 1) {
        return value.toFixed(6);
    } else if (value < 10000) {
        return value.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 4
        });
    } else {
        return value.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
}

// =====================
// ğŸ”¢ è¨ˆç®—æ©Ÿ
// =====================
let calcVal = "0";

function calc(v) {
    if (calcVal === "0" && v !== '.') {
        calcVal = "";
    }
    
    if (v === '.' && calcVal.includes('.')) {
        const lastOperator = Math.max(
            calcVal.lastIndexOf('+'),
            calcVal.lastIndexOf('-'),
            calcVal.lastIndexOf('*'),
            calcVal.lastIndexOf('/')
        );
        
        const lastNumber = calcVal.substring(lastOperator + 1);
        if (lastNumber.includes('.')) {
            return;
        }
    }
    
    calcVal += v;
    updateCalc();
}

function equals() {
    try {
        let expression = calcVal
            .replace(/Ã—/g, '*')
            .replace(/Ã·/g, '/')
            .replace(/âˆ’/g, '-');
        
        const result = eval(expression);
        
        if (isNaN(result) || !isFinite(result)) {
            throw new Error("ç„¡æ•ˆè¨ˆç®—");
        }
        
        calcVal = String(result);
    } catch {
        calcVal = "éŒ¯èª¤";
    }
    updateCalc();
}

function clearCalc() {
    calcVal = "0";
    updateCalc();
}

function updateCalc() {
    document.getElementById("calcDisplay").value = calcVal;
}

// =====================
// ğŸš€ åˆå§‹åŒ–
// =====================
document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹è¼‰å…¥åƒ¹æ ¼
    loadPrices();
    
    // æ¯60ç§’æ›´æ–°ä¸€æ¬¡åƒ¹æ ¼ï¼ˆå…è²»APIé™åˆ¶è¼ƒå¤šï¼‰
    setInterval(loadPrices, 60000);
    
    // æŒ‰ Enter éµè§¸ç™¼è½‰æ›
    document.getElementById('amount').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            convert();
        }
    });
    
    // åˆ‡æ›è²¨å¹£æ™‚è‡ªå‹•è½‰æ›
    document.getElementById('fromCurrency').addEventListener('change', convert);
    document.getElementById('toCurrency').addEventListener('change', convert);
    
    // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºæç¤º
    console.log("åŠ å¯†è²¨å¹£è½‰æ›å™¨å·²è¼‰å…¥");
    console.log("ä½¿ç”¨å…è²» CoinGecko API - å¯èƒ½æœ‰é™åˆ¶");
});
</script>
</body>
</html>
